---
title: "Project"
description: |
  This is our group's project page for the topic on Geographically Weighted Regression
author:
  - name: Team 5 
    url: ...
    affiliation: Singapore Management University
    affiliation_url: https://www.smu.edu.sg
date: "`r Sys.Date()`"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```

```{r}
packages = c('sf', 'tidyverse', 'readxl', 'tmap', 'raster', 'knitr', 'dplyr')
for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p,character.only = T)
}
```


## COVID DATA

```{r}
get.var <- function(vname,df) {
  v <- df[vname] %>% st_set_geometry(NULL)
  v <- unname(v[,1])
  return(v)
}
```

Meninggal function

```{r}
unique_column_data_meninggal <- function(data) {
  thedata <- read_xlsx(data, sheet = "data", .name_repair = "minimal")

  names(thedata) <- make.unique(names(thedata))
  
  data_withmonyear <- thedata %>%
    mutate(thedata, Month = str_sub(data, 49, 51)) %>%
    mutate(thedata, Year = str_sub(data, -22, -19)) %>%
    mutate(thedata, Month_Year = paste(str_sub(data, 49, 51), str_sub(data, -22, -19), sep = "_", collapse = NULL))
  
  extracted_data <- dplyr::select(data_withmonyear, `ID_KEL`, `Nama_provinsi`, `nama_kota`, `nama_kecamatan`, `nama_kelurahan`, `POSITIF`, `Meninggal.1`, `Month`, `Year`, `Month_Year`) %>%
    rename(`Meninggal` = `Meninggal.1`) %>%
    drop_na()
    
  return(extracted_data)
}
```

LOAD MENINGGAL DATA

```{r}
oct21 <- unique_column_data_meninggal("data/aspatial/Standar Kelurahan Data Corona (31 Oktober 2021 Pukul 10.00).xlsx")
```

geospatial

```{r}
dkijkt_sf = st_read(dsn = "data/geospatial", layer = "BATAS_DESA_DESEMBER_2019_DUKCAPIL_DKI_JAKARTA")
```

```{r}
st_crs(dkijkt_sf)
```

```{r}
dkijkt_sf23845 <- st_transform(dkijkt_sf, crs = 23845)
```


```{r}
dkijkt_sf23845_main1 <- filter(dkijkt_sf23845, KAB_KOTA != "KEPULAUAN SERIBU")
```

```{r}
dkijkt_sf23845_main <- dkijkt_sf23845_main1[1:9]
dkijkt_sf23845_main
```

```{r}
dkijkt_covid <- left_join(dkijkt_sf23845_main, oct21, by = c("KODE_DESA" = "ID_KEL"))
```

```{r}
dkijkt_ctrd <- st_centroid(dkijkt_covid, of_largest_polygon = TRUE)
```

```{r}
write.csv(dkijkt_ctrd, "data/dkijkt_ctrd.csv", row.names = FALSE)
```


```{r}
st_write(dkijkt_ctrd, "data/dkijkt_ctrd_xy.csv", layer_options = "GEOMETRY=AS_XY")
```

```{r}
dkijkt_covid_testing <- read_csv("data/dkijkt_ctrd.csv")
```

```{r}
dkijkt_covid_testing <- read_csv("data/dkijkt_ctrd_xy.csv")

dkijkt_covid_testing1 <- st_as_sf(dkijkt_covid_testing,
                          coords = c("X", 
                                     "Y"),
                          crs=23845)
```

```{r}
tmap_mode("view")
tm_shape(dkijkt_covid_testing1)+
  tm_dots()
tmap_mode("plot")
```

## Points of Interests

```{r}
pointsofint_sf = st_read(dsn = "data/points_of_interests", layer = "hotosm_idn_jakarta_points_of_interest_points")
```

### Attraction

```{r}
attraction <- pointsofint_sf %>% filter(tourism == "attraction")
```

```{r}
dkijkt_covid_geo <- dkijkt_covid_testing1$geometry
dkijkt_covid1 <- st_coordinates(dkijkt_covid_geo)
dkijkt_covid2 <- dkijkt_covid1[,1:2]
```

```{r}
attraction_df <- attraction$geometry
correctgeo <- st_as_sf(attraction_df, crs=4326) %>%
                st_transform(crs = 23845)
attractiongeo <- st_coordinates(correctgeo)
```

```{r}
dist_dkijkt_attraction <- spDists(dkijkt_covid2, attractiongeo, longlat=FALSE)
```

```{r}
dist_dkijkt_attraction_df <- data.frame(dist_dkijkt_attraction)

dist_dkijkt_attractiont_min <- dist_dkijkt_attraction_df %>% rowwise() %>% mutate(Min = min(c_across(X1:X191)))

PROX_ATTRACTION <- dist_dkijkt_attractiont_min$Min/1000
```

```{r}
dkijkt_covid_updated <- cbind(dkijkt_covid_testing1, PROX_ATTRACTION)
```

### Place of Worship

```{r}
placeofworship <- pointsofint_sf %>% filter(amenity == "place_of_worship")
```

```{r}
dkijkt_covid_geo <- dkijkt_covid_testing1$geometry
dkijkt_covid1 <- st_coordinates(dkijkt_covid_geo)
dkijkt_covid2 <- dkijkt_covid1[,1:2]
```

```{r}
placeofworship_df <- placeofworship$geometry
correctgeo <- st_as_sf(placeofworship_df, crs=4326) %>%
                st_transform(crs = 23845)
placeofworshipgeo <- st_coordinates(correctgeo)
```

```{r}
dist_dkijkt_placeofworship <- spDists(dkijkt_covid2, placeofworshipgeo, longlat=FALSE)
```

```{r}
dist_dkijkt_placeofworship_df <- data.frame(dist_dkijkt_placeofworship)

dist_dkijkt_placeofworship_min <- dist_dkijkt_placeofworship_df %>% rowwise() %>% mutate(Min = min(c_across(X1:X422)))

PROX_WORSHIP <- dist_dkijkt_placeofworship_min$Min/1000
```

```{r}
dkijkt_covid_updated <- cbind(dkijkt_covid_updated, PROX_WORSHIP)
```

### Restaurant

```{r}
restaurant <- pointsofint_sf %>% filter(amenity == "restaurant")
```

```{r}
dkijkt_covid_geo <- dkijkt_covid_testing1$geometry
dkijkt_covid1 <- st_coordinates(dkijkt_covid_geo)
dkijkt_covid2 <- dkijkt_covid1[,1:2]
```

```{r}
restaurant_df <- restaurant$geometry
correctgeo <- st_as_sf(restaurant_df, crs=4326) %>%
                st_transform(crs = 23845)
restaurantgeo <- st_coordinates(correctgeo)
```

```{r}
dist_dkijkt_restaurant <- spDists(dkijkt_covid2, restaurantgeo, longlat=FALSE)
```

```{r}
dist_dkijkt_restaurant_df <- data.frame(dist_dkijkt_restaurant)

dist_dkijkt_restaurant_min <- dist_dkijkt_restaurant_df %>% rowwise() %>% mutate(Min = min(c_across(X1:X1082)))

PROX_RESTAURANT <- dist_dkijkt_restaurant_min$Min/1000
```

```{r}
dkijkt_covid_updated <- cbind(dkijkt_covid_updated, PROX_RESTAURANT)
```

### Mall

```{r}
mall <- pointsofint_sf %>% filter(shop == "mall")
```

```{r}
dkijkt_covid_geo <- dkijkt_covid_testing1$geometry
dkijkt_covid1 <- st_coordinates(dkijkt_covid_geo)
dkijkt_covid2 <- dkijkt_covid1[,1:2]
```

```{r}
mall_df <- mall$geometry
correctgeo <- st_as_sf(mall_df, crs=4326) %>%
                st_transform(crs = 23845)
mallgeo <- st_coordinates(correctgeo)
```

```{r}
dist_dkijkt_mall <- spDists(dkijkt_covid2, mallgeo, longlat=FALSE)
```

```{r}
dist_dkijkt_mall_df <- data.frame(dist_dkijkt_mall)

dist_dkijkt_mall_min <- dist_dkijkt_mall_df %>% rowwise() %>% mutate(Min = min(c_across(X1:X95)))

PROX_MALL <- dist_dkijkt_mall_min$Min/1000
```

```{r}
dkijkt_covid_updated <- cbind(dkijkt_covid_updated, PROX_MALL)
```

### Supermarket

```{r}
supermarket <- pointsofint_sf %>% filter(shop == "supermarket")
```

```{r}
dkijkt_covid_geo <- dkijkt_covid_testing1$geometry
dkijkt_covid1 <- st_coordinates(dkijkt_covid_geo)
dkijkt_covid2 <- dkijkt_covid1[,1:2]
```

```{r}
supermarket_df <- supermarket$geometry
correctgeo <- st_as_sf(supermarket_df, crs=4326) %>%
                st_transform(crs = 23845)
supermarketgeo <- st_coordinates(correctgeo)
```

```{r}
dist_dkijkt_supermarket <- spDists(dkijkt_covid2, supermarketgeo, longlat=FALSE)
```

```{r}
dist_dkijkt_supermarket_df <- data.frame(dist_dkijkt_supermarket)

dist_dkijkt_supermarket_min <- dist_dkijkt_supermarket_df %>% rowwise() %>% mutate(Min = min(c_across(X1:X261)))

PROX_SUPERMARKET <- dist_dkijkt_supermarket_min$Min/1000
```

```{r}
dkijkt_covid_updated <- cbind(dkijkt_covid_updated, PROX_SUPERMARKET)
```

### Convenience

```{r}
convenience <- pointsofint_sf %>% filter(shop == "convenience")
```

```{r}
dkijkt_covid_geo <- dkijkt_covid_testing1$geometry
dkijkt_covid1 <- st_coordinates(dkijkt_covid_geo)
dkijkt_covid2 <- dkijkt_covid1[,1:2]
```

```{r}
convenience_df <- convenience$geometry
correctgeo <- st_as_sf(convenience_df, crs=4326) %>%
                st_transform(crs = 23845)
conveniencegeo <- st_coordinates(correctgeo)
```

```{r}
dist_dkijkt_convenience <- spDists(dkijkt_covid2, conveniencegeo, longlat=FALSE)
```

```{r}
dist_dkijkt_convenience_df <- data.frame(dist_dkijkt_convenience)

dist_dkijkt_convenience_min <- dist_dkijkt_convenience_df %>% rowwise() %>% mutate(Min = min(c_across(X1:X848)))

PROX_CONVENIENCE <- dist_dkijkt_convenience_min$Min/1000
```

```{r}
dkijkt_covid_updated <- cbind(dkijkt_covid_updated, PROX_CONVENIENCE)
```

## Education

```{r}
education_sf = st_read(dsn = "data/education", layer = "hotosm_idn_jakarta_education_facilities_points")
```
### Kindergartens

```{r}
kindergartens <- education_sf %>% filter(amenity == "kindergarten")
```

```{r}
dkijkt_covid_geo <- dkijkt_covid_testing1$geometry
dkijkt_covid1 <- st_coordinates(dkijkt_covid_geo)
dkijkt_covid2 <- dkijkt_covid1[,1:2]
```

```{r}
kindergartens_df <- kindergartens$geometry
correctgeo <- st_as_sf(kindergartens_df, crs=4326) %>%
                st_transform(crs = 23845)
kindergartensgeo <- st_coordinates(correctgeo)
```

```{r}
dist_dkijkt_kindergartens <- spDists(dkijkt_covid2, kindergartensgeo, longlat=FALSE)
```

```{r}
dist_dkijkt_kindergartens_df <- data.frame(dist_dkijkt_kindergartens)

dist_dkijkt_kindergartens_min <- dist_dkijkt_kindergartens_df %>% rowwise() %>% mutate(Min = min(c_across(X1:X443)))

PROX_KINDERGARTENS <- dist_dkijkt_kindergartens_min$Min/1000
```

```{r}
dkijkt_covid_updated <- cbind(dkijkt_covid_updated, PROX_KINDERGARTENS)
```

### School

```{r}
school <- education_sf %>% filter(amenity == "school")
```

```{r}
dkijkt_covid_geo <- dkijkt_covid_testing1$geometry
dkijkt_covid1 <- st_coordinates(dkijkt_covid_geo)
dkijkt_covid2 <- dkijkt_covid1[,1:2]
```

```{r}
school_df <- school$geometry
correctgeo <- st_as_sf(school_df, crs=4326) %>%
                st_transform(crs = 23845)
schoolgeo <- st_coordinates(correctgeo)
```

```{r}
dist_dkijkt_school <- spDists(dkijkt_covid2, schoolgeo, longlat=FALSE)
```

```{r}
dist_dkijkt_school_df <- data.frame(dist_dkijkt_school)

dist_dkijkt_school_min <- dist_dkijkt_school_df %>% rowwise() %>% mutate(Min = min(c_across(X1:X593)))

PROX_SCHOOL <- dist_dkijkt_school_min$Min/1000
```

```{r}
dkijkt_covid_updated <- cbind(dkijkt_covid_updated, PROX_SCHOOL)
```

## Airports

```{r}
airport_sf = st_read(dsn = "data/airport", layer = "hotosm_idn_jakarta_airports_points")
```

```{r}
airport_sf <- st_as_sf(airport_sf, crs=4326) %>%
                st_transform(crs = 23845)
```

### Terminal

```{r}
terminal <- airport_sf %>% filter(aeroway == "terminal")
```

```{r}
dkijkt_covid_geo <- dkijkt_covid_testing1$geometry
dkijkt_covid1 <- st_coordinates(dkijkt_covid_geo)
dkijkt_covid2 <- dkijkt_covid1[,1:2]
```

```{r}
terminal_df <- terminal$geometry
correctgeo <- st_as_sf(terminal_df, crs=23845)
terminalgeo <- st_coordinates(correctgeo)
```

```{r}
dist_dkijkt_terminal <- spDists(dkijkt_covid2, terminalgeo, longlat=FALSE)
```

```{r}
dist_dkijkt_terminal_df <- data.frame(dist_dkijkt_terminal)

dist_dkijkt_terminal_min <- dist_dkijkt_terminal_df %>% rowwise() %>% mutate(Min = min(c_across(X1:X8)))

PROX_TERMINAL <- dist_dkijkt_terminal_min$Min/1000
```

```{r}
dkijkt_covid_updated <- cbind(dkijkt_covid_updated, PROX_TERMINAL)
```

## Healthcare

```{r}
healthcare_sf = st_read(dsn = "data/health_facilities", layer = "IDN_hospital_point")
```

```{r}
healthcare <- st_transform(healthcare_sf, crs = 23845)
```

```{r}
healthcare_dkijkt <- healthcare %>%
                      filter(Province == "DKI Jakarta") %>%
                      drop_na(District)
```

```{r}
dkijkt_covid_geo <- dkijkt_covid_testing1$geometry
dkijkt_covid1 <- st_coordinates(dkijkt_covid_geo)
dkijkt_covid2 <- dkijkt_covid1[,1:2]
```

```{r}
healthcare_dkijkt_df <- healthcare_dkijkt$geometry
correctgeo <- st_as_sf(healthcare_dkijkt_df, crs=23845)
healthcare_dkijktgeo <- st_coordinates(correctgeo)
```

```{r}
dist_dkijkt_healthcare <- spDists(dkijkt_covid2, healthcare_dkijktgeo, longlat=FALSE)
```

```{r}
dist_dkijkt_healthcare_df <- data.frame(dist_dkijkt_healthcare)

dist_dkijkt_healthcare_min <- dist_dkijkt_healthcare_df %>% rowwise() %>% mutate(Min = min(c_across(X1:X129)))

PROX_HEALTHCARE <- dist_dkijkt_healthcare_min$Min/1000
```

```{r}
dkijkt_covid_updated <- cbind(dkijkt_covid_updated, PROX_HEALTHCARE)
```

## Railway

```{r}
railways_sf = st_read(dsn = "data/railways", layer = "hotosm_idn_jakarta_railways_polygons")
```

```{r}
railways <- st_transform(railways_sf, crs = 23845)
```

```{r}
railways <- st_centroid(railways, of_largest_polygon = TRUE)
```


```{r}
dkijkt_covid_geo <- dkijkt_covid_testing1$geometry
dkijkt_covid1 <- st_coordinates(dkijkt_covid_geo)
dkijkt_covid2 <- dkijkt_covid1[,1:2]
```

```{r}
railways_df <- railways$geometry
correctgeo <- st_as_sf(railways_df, crs=23845)
railwaysgeo <- st_coordinates(correctgeo)
```

```{r}
dist_dkijkt_railways <- spDists(dkijkt_covid2, railwaysgeo, longlat=FALSE)
```

```{r}
dist_dkijkt_railways_df <- data.frame(dist_dkijkt_railways)

dist_dkijkt_railways_min <- dist_dkijkt_railways_df %>% rowwise() %>% mutate(Min = min(c_across(X1:X25)))

PROX_RAILWAYS <- dist_dkijkt_railways_min$Min/1000
```

```{r}
dkijkt_covid_updated <- cbind(dkijkt_covid_updated, PROX_RAILWAYS)
```

### export a copy

```{r}
st_write(dkijkt_covid_updated, "data/dkijkt_covid_updated.csv", layer_options = "GEOMETRY=AS_XY")
```

## Load latest updated csv data.

```{r}
dkijkt_covid_updated_xy <- read_csv("data/dkijkt_covid_updated.csv")

dkijkt_covid_updated_xy <- st_as_sf(dkijkt_covid_updated_xy,
                          coords = c("X", 
                                     "Y"),
                          crs=23845)

dkijkt_covid_updated_xy_df <- as.data.frame(dkijkt_covid_updated_xy)
```


```{r}
library(corrplot)
corrplot(cor(dkijkt_covid_updated_xy_df[, 19:29]), diag = FALSE, order = "AOE",
         tl.pos = "td", tl.cex = 0.7, number.cex=0.5, method = "number", type = "upper")
```

OTHERS



Population Counts (Unconstrained 2020, 1km resolution)

```{r}
library(raster)
str_name<-'data/population/idn_ppp_2020_1km_Aggregated.tif'

population2020_raster = raster(str_name)
```

```{r}
tmap_mode("view")
tm_shape(population2020_raster) + 
  tm_raster(palette = "Paired", alpha = 0.7) +
  tm_basemap("OpenStreetMap")
tmap_mode("plot")
```


Total Density 2020 Unconstrained, Unadjusted, 1km

```{r}
library(raster)
str_name<-'data/population/idn_pd_2020_1km.tif'

populationden2020_raster = raster(str_name)
```

```{r}
tmap_mode("view")
tm_shape(populationden2020_raster) + 
  tm_raster(palette = "Paired", alpha = 0.7) +
  tm_basemap("OpenStreetMap")
tmap_mode("plot")
```

Birth 2015 

```{r}
library(raster)
str_name<-'data/birth/IDN_births_pp_v2_2015.tif'

birth_raster = raster(str_name)
```

```{r}
tmap_mode("view")
tm_shape(birth_raster) + 
  tm_raster(palette = "Paired", alpha = 0.7) +
  tm_basemap("OpenStreetMap")
tmap_mode("plot")
```

